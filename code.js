// Generated by CoffeeScript 1.4.0
(function() {
  var Canvas, Food, Game, Point, Snake, SnakeSegment,
    __hasProp = {}.hasOwnProperty;

  Canvas = (function() {

    Canvas.prototype.width = 600;

    Canvas.prototype.height = 400;

    function Canvas(background) {
      this.background = background != null ? background : 'white';
      this.canvas = document.getElementById('myCanvas');
      this.ctx = this.canvas.getContext('2d');
    }

    Canvas.prototype.clear = function() {
      this.ctx.fillStyle = this.background;
      return this.ctx.fillRect(0, 0, this.width, this.height);
    };

    return Canvas;

  })();

  Point = (function() {

    function Point(x, y) {
      this.x = x;
      this.y = y;
    }

    return Point;

  })();

  Food = (function() {

    function Food(x, y, color, value) {
      this.x = x;
      this.y = y;
      this.color = color != null ? color : 'orange';
      this.value = value != null ? value : 3;
    }

    Food.prototype.paint = function(ctx) {
      ctx.fillStyle = this.color;
      return ctx.fillRect(this.x * 10, this.y * 10, 10, 10);
    };

    Food.prototype.distance = function(point) {
      var deltaX, deltaY;
      deltaX = this.x - point.x;
      deltaY = this.y - point.y;
      return deltaX * deltaX + deltaY * deltaY;
    };

    return Food;

  })();

  SnakeSegment = (function() {

    function SnakeSegment(x, y, next) {
      this.x = x;
      this.y = y;
      this.next = next != null ? next : null;
    }

    SnakeSegment.prototype.paint = function(ctx, color) {
      ctx.fillStyle = color;
      return ctx.fillRect(this.x * 10, this.y * 10, 10, 10);
    };

    return SnakeSegment;

  })();

  Snake = (function() {

    function Snake(direction, color, headColor) {
      var middle, tail;
      this.direction = direction != null ? direction : 'left';
      this.color = color != null ? color : 'green';
      this.headColor = headColor != null ? headColor : 'red';
      tail = new SnakeSegment(12, 10);
      middle = new SnakeSegment(11, 10, tail);
      this.head = new SnakeSegment(10, 10, middle);
    }

    Snake.prototype.move = function() {
      var newHead, segment, _results;
      newHead = (function() {
        switch (this.direction) {
          case 'left':
            return new SnakeSegment(this.head.x - 1, this.head.y, this.head);
          case 'right':
            return new SnakeSegment(this.head.x + 1, this.head.y, this.head);
          case 'up':
            return new SnakeSegment(this.head.x, this.head.y - 1, this.head);
          case 'down':
            return new SnakeSegment(this.head.x, this.head.y + 1, this.head);
        }
      }).call(this);
      this.head = newHead;
      if (this.extra > 0) {
        this.extra--;
        return;
      }
      segment = this.head;
      _results = [];
      while (segment) {
        if (segment.next && !segment.next.next) {
          segment.next = null;
          break;
        }
        _results.push(segment = segment.next);
      }
      return _results;
    };

    Snake.prototype.paint = function(ctx) {
      var segment, _results;
      this.head.paint(ctx, this.headColor);
      segment = this.head.next;
      _results = [];
      while (segment) {
        segment.paint(ctx, this.color);
        _results.push(segment = segment.next);
      }
      return _results;
    };

    Snake.prototype.checkPosition = function(x, y, head) {
      var segment;
      if (head == null) {
        head = true;
      }
      if (head) {
        segment = this.head;
      } else {
        segment = this.head.next;
      }
      while (segment) {
        if (segment.x === x && segment.y === y) {
          return true;
        }
        segment = segment.next;
      }
      return false;
    };

    Snake.prototype.checkPoint = function(point) {
      var segment;
      segment = this.head.next;
      while (segment) {
        if (segment.x === point.x && segment.y === point.y) {
          return true;
        }
        segment = segment.next;
      }
      return false;
    };

    return Snake;

  })();

  Game = (function() {

    function Game() {
      var processCallback;
      this.canvas = new Canvas;
      this.canvas.clear();
      this.snake = new Snake;
      this.food = this.addFood();
      processCallback = this.process.bind(this);
      this.processing = setInterval(processCallback, 100);
    }

    Game.prototype.randomInt = function(lower, upper) {
      var start;
      start = Math.random();
      return Math.floor(start * (upper - lower + 1) + lower);
    };

    Game.prototype.checkCollision = function() {
      if (this.snake.head.x === this.food.x && this.snake.head.y === this.food.y) {
        console.log('eaten');
        this.snake.extra = this.food.value;
        this.food = this.addFood();
      }
      if (this.snake.checkPosition(this.snake.head.x, this.snake.head.y, false)) {
        this.gameOver();
        return true;
      }
      if (this.snake.head.x < 0 || this.snake.head.x > 59 || this.snake.head.y < 0 || this.snake.head.y > 39) {
        this.gameOver();
        return true;
      }
      return false;
    };

    Game.prototype.addFood = function() {
      var x, y;
      while (true) {
        x = this.randomInt(0, 59);
        y = this.randomInt(0, 39);
        if (!this.snake.checkPosition(x, y)) {
          break;
        }
      }
      return new Food(x, y, 'orange', 10);
    };

    Game.prototype.gameOver = function() {
      clearInterval(this.processing);
      return document.getElementsByTagName('body')[0].className += ' tragedy';
    };

    Game.prototype.process = function() {
      this.think();
      this.snake.move();
      if (this.checkCollision()) {
        return;
      }
      this.canvas.clear();
      this.snake.paint(this.canvas.ctx);
      return this.food.paint(this.canvas.ctx);
    };

    Game.prototype.think = function() {
      var bestWay, directions, distances, filtered, key, value, x, y;
      x = this.snake.head.x;
      y = this.snake.head.y;
      directions = {
        up: new Point(x, y - 1),
        down: new Point(x, y + 1),
        left: new Point(x - 1, y),
        right: new Point(x + 1, y)
      };
      filtered = {};
      for (key in directions) {
        if (!__hasProp.call(directions, key)) continue;
        value = directions[key];
        if (this.snake.checkPoint(value)) {
          delete directions[key];
        }
      }
      distances = {};
      for (key in directions) {
        if (!__hasProp.call(directions, key)) continue;
        value = directions[key];
        distances[key] = this.food.distance(value);
      }
      bestWay = null;
      for (key in distances) {
        if (!__hasProp.call(distances, key)) continue;
        value = distances[key];
        if (!bestWay) {
          bestWay = key;
        }
        if (distances[bestWay] > value) {
          bestWay = key;
        }
      }
      if (bestWay) {
        return this.snake.direction = bestWay;
      }
    };

    return Game;

  })();

  window.start = function() {
    var game;
    return game = new Game;
  };

}).call(this);
